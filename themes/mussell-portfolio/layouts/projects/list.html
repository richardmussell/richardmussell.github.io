{{ define "main" }}
{{ $allProjects := where .Site.RegularPages "Section" "projects" }}
{{ $allCategories := slice "DISTRIBUTED SYSTEMS & SCALE" "CLOUD AUTOMATION & IAC" "SRE & SECURITY ENGINEERING" "RELEASE ENGINEERING & CI/CD" "PLATFORM ENGINEERING & GOVERNANCE" }}
{{ $rdCategory := "HYBRID CLOUD & EDGE R&D" }}
{{ $rdTaxonomy := index .Site.Taxonomies.categories ($rdCategory | lower) }}
{{ $rdProjects := slice }}
{{ if $rdTaxonomy }}
  {{ range $rdTaxonomy }}
    {{ $rdProjects = $rdProjects | append .Page }}
  {{ end }}
{{ end }}

<!-- Collect all unique tags for filter, excluding generic tags -->
{{ $genericTags := slice "Automation" "Best Practices" "Infrastructure" "Infrastructure as Code" "Platform Engineering" "Production Systems" "Security" "Monitoring" "Modules" "Configuration Management" }}
{{ $allTags := slice }}
{{ range $allProjects }}
  {{ range .Params.tags }}
    {{ $tag := . }}
    {{ $isGeneric := false }}
    {{ range $genericTags }}
      {{ if eq (lower $tag) (lower .) }}
        {{ $isGeneric = true }}
      {{ end }}
    {{ end }}
    {{ if not $isGeneric }}
      {{ $allTags = $allTags | append $tag }}
    {{ end }}
  {{ end }}
{{ end }}
{{ $uniqueTags := $allTags | uniq | sort }}

<!-- Strategic Domain Tags (High-Signal Mastery) -->
{{ $strategicDomains := dict
  "Runtime & Performance" (slice "eBPF" "Cilium" "WasmEdge" "NVIDIA MIG" "TSN (IEEE 802.1)")
  "Edge & Sovereign" (slice "Bare-Metal" "Tinkerbell" "Redfish" "DTN (Delay-Tolerant)" "TPM / Root-of-Trust")
  "Advanced Orchestration" (slice "Multi-Cluster GitOps" "SPIFFE/SPIRE" "Sovereign AI" "OTEC Integration" "Cross-Region High Availability")
}}

<!-- Skip to Content Link -->
<a href="#registry-content" class="skip-to-content">Skip to Content</a>

<div class="technical-registry">
  <!-- Sticky Sidebar TOC -->
  <nav class="registry-sidebar" aria-label="Project Categories">
    <div class="sidebar-header">
      <h2 class="sidebar-title">Registry</h2>
      <span class="sidebar-count">{{ len $allProjects }} Services</span>
    </div>
    <ul class="toc-list">
      <!-- Production Services -->
      {{ range $allCategories }}
      {{ $categoryName := . }}
      {{ $categorySlug := $categoryName | lower | replaceRE "&" "-" | replaceRE "/" "-" | replaceRE "\\s+" "-" | replaceRE "-+" "-" | replaceRE "^-|-$" "" | urlize }}
      {{ $taxonomy := index $.Site.Taxonomies.categories ($categoryName | lower) }}
      {{ $categoryProjects := slice }}
      {{ if $taxonomy }}
        {{ range $taxonomy }}
          {{ $categoryProjects = $categoryProjects | append .Page }}
        {{ end }}
      {{ end }}
      {{ if gt (len $categoryProjects) 0 }}
      <li class="toc-item">
        <a href="#{{ $categorySlug }}" class="toc-link" data-category="{{ $categoryName | lower }}" data-section-id="{{ $categorySlug }}">
          <span class="toc-status-dot"></span>
          <span class="toc-category">{{ $categoryName }}</span>
          <span class="toc-count-badge">{{ len $categoryProjects }}</span>
        </a>
      </li>
      {{ end }}
      {{ end }}
      
      <!-- Visual Separator -->
      {{ if gt (len $rdProjects) 0 }}
      <li class="toc-separator" aria-hidden="true"></li>
      {{ end }}
      
      <!-- Strategic R&D -->
      {{ if gt (len $rdProjects) 0 }}
      <li class="toc-item">
        <a href="#global-rd-initiatives" class="toc-link toc-link-rd" data-category="rd" data-section-id="global-rd-initiatives">
          <span class="toc-status-dot toc-status-dot-rd"></span>
          <span class="toc-category">GLOBAL R&D INITIATIVES</span>
          <span class="toc-count-badge">{{ len $rdProjects }}</span>
        </a>
      </li>
      {{ end }}
    </ul>
  </nav>

  <!-- Main Content Area -->
  <div class="registry-main" id="registry-content">
    <!-- Enterprise Discovery Layer -->
    <div class="discovery-layer">
      <div class="search-container">
        <label for="service-search" class="sr-only">Search services by name, description, or technology</label>
        <div class="search-input-wrapper">
          <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <input 
            type="search" 
            id="service-search" 
            class="service-search" 
            placeholder="Search services..." 
            aria-label="Search services"
            autocomplete="off"
          />
          <span class="search-shortcut-hint" aria-hidden="true">⌘K</span>
        </div>
      </div>

      <div class="filter-container">
        <label class="filter-label">FILTER BY STRATEGIC DOMAIN</label>
        <div class="strategic-domains-filters">
          {{ range $domainName, $domainTags := $strategicDomains }}
          <div class="domain-filter-group">
            <h4 class="domain-group-title">{{ $domainName | upper }}</h4>
            <div class="tag-filters" role="group" aria-label="{{ $domainName }} filters">
              {{ range $domainTags }}
              <button 
                type="button" 
                class="tag-filter strategic-tag" 
                data-tag="{{ . | lower }}"
                role="checkbox"
                aria-checked="false"
                aria-label="Filter by {{ . }}"
              >
                <span class="tag-name">{{ . }}</span>
                <svg class="tag-check" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
              </button>
              {{ end }}
            </div>
          </div>
          {{ end }}
        </div>
        <!-- Legacy tags (non-generic) - Always Expanded -->
        {{ if $uniqueTags }}
        <div class="legacy-tags-section">
          <h4 class="legacy-tags-header">EXTENDED STACK</h4>
          <div class="tag-filters legacy-tags" role="group" aria-label="Additional technology filters">
            {{ range $uniqueTags }}
            <button 
              type="button" 
              class="tag-filter legacy-tag" 
              data-tag="{{ . | lower }}"
              role="checkbox"
              aria-checked="false"
              aria-label="Filter by {{ . }}"
            >
              <span class="tag-name">{{ . }}</span>
              <svg class="tag-check" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            </button>
            {{ end }}
          </div>
        </div>
        {{ end }}
      </div>
    </div>

    <!-- System Registry Content -->
    <div class="registry-content">
      <!-- Global R&D Initiatives Sub-Registry -->
      {{ $rdCategory := "HYBRID CLOUD & EDGE R&D" }}
      {{ $rdTaxonomy := index $.Site.Taxonomies.categories ($rdCategory | lower) }}
      {{ $rdProjects := slice }}
      {{ if $rdTaxonomy }}
        {{ range $rdTaxonomy }}
          {{ $rdProjects = $rdProjects | append .Page }}
        {{ end }}
      {{ end }}
      {{ if gt (len $rdProjects) 0 }}
      <section id="global-rd-initiatives" class="registry-section rd-registry" data-category="rd">
        <h2 id="heading-rd" class="section-heading">
          <span class="rd-indicator"></span>
          GLOBAL_RESEARCH_&_DEVELOPMENT_INITIATIVES
        </h2>
        
        <!-- Global Deployment Map -->
        <div class="global-deployment-map-container">
          <div class="deployment-map-header">
            <h3 class="map-title">GLOBAL_DEPLOYMENT_MAP</h3>
            <span class="map-subtitle">Edge Nodes & Autonomous Systems</span>
          </div>
          <div class="deployment-map-wrapper">
            <svg class="global-deployment-map" viewBox="0 0 1000 500" xmlns="http://www.w3.org/2000/svg" aria-label="Global deployment map showing edge nodes">
              <!-- Dot Grid Pattern Background -->
              <defs>
                <pattern id="dot-grid" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
                  <circle cx="10" cy="10" r="0.5" fill="rgba(113, 113, 122, 0.2)" />
                </pattern>
              </defs>
              <rect width="1000" height="500" fill="rgba(9, 9, 11, 0.4)" />
              <rect width="1000" height="500" fill="url(#dot-grid)" />
              
              <!-- Simplified World Map Outline (Minimalist) -->
              <g class="world-outline" fill="none" stroke="rgba(63, 63, 70, 0.3)" stroke-width="0.5">
                <!-- North America -->
                <path d="M 150 100 L 180 80 L 220 90 L 250 110 L 280 130 L 300 150 L 320 180 L 330 200 L 320 220 L 300 240 L 280 250 L 250 260 L 220 250 L 200 240 L 180 220 L 170 200 L 160 180 L 150 150 Z" />
                <!-- South America -->
                <path d="M 250 250 L 280 240 L 300 250 L 320 270 L 330 300 L 340 330 L 350 360 L 340 380 L 320 400 L 300 410 L 280 400 L 260 380 L 250 360 L 240 330 L 250 300 Z" />
                <!-- Europe -->
                <path d="M 450 80 L 480 70 L 500 80 L 520 100 L 530 120 L 520 140 L 500 150 L 480 140 L 460 120 L 450 100 Z" />
                <!-- Africa -->
                <path d="M 480 150 L 520 140 L 540 160 L 550 200 L 540 240 L 530 280 L 520 320 L 500 340 L 480 330 L 470 300 L 480 250 L 490 200 Z" />
                <!-- Asia -->
                <path d="M 550 60 L 650 50 L 750 60 L 800 80 L 820 120 L 800 160 L 750 200 L 700 220 L 650 240 L 600 250 L 550 240 L 520 220 L 500 180 L 520 140 L 550 100 Z" />
                <!-- Australia -->
                <path d="M 750 280 L 780 270 L 800 280 L 820 300 L 800 320 L 780 330 L 750 320 L 730 300 Z" />
              </g>
              
              <!-- Deployment Nodes -->
              <!-- Maine, USA (Approx: 300, 120) -->
              <g class="deployment-node" data-node="maine">
                <circle cx="300" cy="120" r="8" fill="rgb(99, 102, 241)" class="node-pulse" />
                <circle cx="300" cy="120" r="12" fill="rgba(99, 102, 241, 0.2)" class="node-ring" />
                <circle cx="300" cy="120" r="16" fill="rgba(99, 102, 241, 0.1)" class="node-ring-outer" />
              </g>
              
              <!-- Tokyo, Japan (Approx: 800, 140) -->
              <g class="deployment-node" data-node="tokyo">
                <circle cx="800" cy="140" r="8" fill="rgb(99, 102, 241)" class="node-pulse" />
                <circle cx="800" cy="140" r="12" fill="rgba(99, 102, 241, 0.2)" class="node-ring" />
                <circle cx="800" cy="140" r="16" fill="rgba(99, 102, 241, 0.1)" class="node-ring-outer" />
              </g>
              
              <!-- Quintana Roo, Mexico (Approx: 220, 200) -->
              <g class="deployment-node" data-node="quintana-roo">
                <circle cx="220" cy="200" r="8" fill="rgb(99, 102, 241)" class="node-pulse" />
                <circle cx="220" cy="200" r="12" fill="rgba(99, 102, 241, 0.2)" class="node-ring" />
                <circle cx="220" cy="200" r="16" fill="rgba(99, 102, 241, 0.1)" class="node-ring-outer" />
              </g>
            </svg>
            
            <!-- System Pulse Popup -->
            <div class="system-pulse-popup" id="system-pulse-popup" role="tooltip" aria-hidden="true">
              <div class="pulse-header">
                <span class="pulse-title">SYSTEM_PULSE</span>
                <span class="pulse-status-dot"></span>
              </div>
              <div class="pulse-metrics">
                <div class="pulse-metric">
                  <span class="pulse-label">LATENCY</span>
                  <span class="pulse-value">&lt;5ms</span>
                </div>
                <div class="pulse-metric">
                  <span class="pulse-label">UPTIME</span>
                  <span class="pulse-value">99.999%</span>
                </div>
                <div class="pulse-metric">
                  <span class="pulse-label">POWER</span>
                  <span class="pulse-value">OTEC RENEWABLE</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        {{ range $index, $project := $rdProjects }}
        <article class="system-spec rd-spec" data-project-id="{{ $project.File.UniqueID }}" data-tags="{{ range $project.Params.tags }}{{ . | lower }} {{ end }}" data-index="{{ $index }}">
          <!-- R&D Phase Ribbon -->
          <div class="rd-phase-ribbon">
            <span class="rd-phase-text">R&D_PHASE: ALPHA</span>
          </div>
          
          <!-- Header Section -->
          <div class="spec-header">
            <div class="spec-title-row">
              <h3 class="spec-title">
                <a href="{{ $project.RelPermalink }}" class="spec-title-link">{{ $project.Title }}</a>
              </h3>
              <div class="spec-status-badges">
                <span class="status-badge status-experimental" aria-label="Experimental R&D">EXPERIMENTAL</span>
              </div>
            </div>
            
            <!-- R&D Metadata -->
            <div class="rd-metadata">
              <span class="rd-meta-item">LATITUDE: [COORD]</span>
              <span class="rd-meta-separator">|</span>
              <span class="rd-meta-item">SYSTEM: EXPERIMENTAL</span>
            </div>
            
            <!-- Quick Metrics -->
            {{ if $project.Params.impactMetrics }}
            <div class="spec-metrics">
              {{ range first 4 $project.Params.impactMetrics }}
              <span class="metric-tag">{{ . }}</span>
              {{ end }}
            </div>
            {{ end }}
          </div>
          
          <!-- Split-Pane Core -->
          <div class="spec-core">
            <!-- Column A: Context -->
            <div class="spec-context">
              <div class="spec-abstract">
                <p>{{ $project.Description }}</p>
              </div>
              
              {{ if or $project.Params.designTradeoffs $project.Params.failureModes }}
              <div class="architecture-ledger">
                <h4 class="ledger-title">Architecture Ledger</h4>
                <ul class="ledger-list">
                  {{ if $project.Params.designTradeoffs }}
                  <li class="ledger-item">
                    <strong>Design Decision:</strong> {{ $project.Params.designTradeoffs }}
                  </li>
                  {{ end }}
                  {{ if $project.Params.failureModes }}
                    {{ range first 2 $project.Params.failureModes }}
                    <li class="ledger-item">
                      <strong>Resilience Pattern:</strong> {{ .scenario | default "N/A" }} → {{ .response | default "N/A" }}
                    </li>
                    {{ end }}
                  {{ end }}
                </ul>
              </div>
              {{ end }}
            </div>

            <!-- Column B: Media Stage -->
            <div class="spec-media">
              <div class="media-viewport blueprint-viewport">
                <div class="blueprint-grid-overlay"></div>
                <div class="viewport-tabs" role="tablist" aria-label="Technical viewport tabs">
                  <button 
                    class="viewport-tab active" 
                    role="tab" 
                    aria-selected="true" 
                    aria-expanded="true"
                    aria-controls="diagram-{{ $project.File.UniqueID }}"
                    id="tab-diagram-{{ $project.File.UniqueID }}"
                    data-tab="diagram"
                    data-project-id="{{ $project.File.UniqueID }}"
                  >
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                    </svg>
                    Diagram
                  </button>
                </div>
                <div class="viewport-content">
                  <div 
                    id="diagram-{{ $project.File.UniqueID }}" 
                    class="viewport-pane active" 
                    role="tabpanel" 
                    aria-labelledby="tab-diagram-{{ $project.File.UniqueID }}"
                  >
                    {{ if $project.Params.architectureDiagramUrl }}
                    <div class="diagram-container">
                      <img 
                        data-src="{{ $project.Params.architectureDiagramUrl }}" 
                        alt="Architecture diagram for {{ $project.Title }}"
                        class="diagram-image lazy-diagram"
                        loading="lazy"
                      />
                    </div>
                    {{ else }}
                    <div class="diagram-placeholder">
                      <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                      </svg>
                      <p>Architecture Diagram</p>
                    </div>
                    {{ end }}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Footer Actions -->
          <div class="spec-footer">
            <a href="{{ $project.RelPermalink }}" class="spec-link">View Full Specification →</a>
          </div>
        </article>
        {{ end }}
      </section>
      {{ end }}
      
      {{ range $allCategories }}
      {{ $categoryName := . }}
      {{ $categorySlug := $categoryName | lower | replaceRE "&" "-" | replaceRE "/" "-" | replaceRE "\\s+" "-" | replaceRE "-+" "-" | replaceRE "^-|-$" "" | urlize }}
      {{ $taxonomy := index $.Site.Taxonomies.categories ($categoryName | lower) }}
      {{ $categoryProjects := slice }}
      {{ if $taxonomy }}
        {{ range $taxonomy }}
          {{ $categoryProjects = $categoryProjects | append .Page }}
        {{ end }}
      {{ end }}
      {{ if gt (len $categoryProjects) 0 }}
      <section id="{{ $categorySlug }}" class="registry-section" data-category="{{ $categoryName | lower }}">
        <h2 id="heading-{{ $categorySlug }}" class="section-heading">{{ $categoryName }}</h2>
        
        {{ range $index, $project := $categoryProjects }}
        <article class="system-spec" data-project-id="{{ $project.File.UniqueID }}" data-tags="{{ range $project.Params.tags }}{{ . | lower }} {{ end }}" data-index="{{ $index }}" style="--stagger-delay: {{ mul $index 0.05 }}s;">
          <!-- Header Section -->
          <div class="spec-header">
            <div class="spec-title-row">
              <h3 class="spec-title">
                <a href="{{ $project.RelPermalink }}" class="spec-title-link">{{ $project.Title }}</a>
              </h3>
              <div class="spec-status-badges">
                {{ if $project.Params.productionReady }}
                <span class="status-badge status-production" aria-label="Production ready">PRODUCTION</span>
                {{ else }}
                <span class="status-badge status-experimental" aria-label="Experimental">EXPERIMENTAL</span>
                {{ end }}
              </div>
            </div>
            
            <!-- Mastery Ribbon (Strategic Domain Tags) -->
            {{ $strategicTags := slice }}
            {{ range $project.Params.tags }}
              {{ $tag := . }}
              {{ $isStrategic := false }}
              {{ range $domainName, $domainTags := $strategicDomains }}
                {{ range $domainTags }}
                  {{ if eq (lower $tag) (lower .) }}
                    {{ $isStrategic = true }}
                  {{ end }}
                {{ end }}
              {{ end }}
              {{ if $isStrategic }}
                {{ $strategicTags = $strategicTags | append $tag }}
              {{ end }}
            {{ end }}
            {{ if $strategicTags }}
            <div class="mastery-ribbon">
              {{ range $strategicTags }}
              <span class="mastery-tag">{{ . }}</span>
              {{ end }}
            </div>
            {{ end }}
            
            <!-- Quick Metrics -->
            {{ if $project.Params.impactMetrics }}
            <div class="spec-metrics">
              {{ range first 4 $project.Params.impactMetrics }}
              <span class="metric-tag">{{ . }}</span>
              {{ end }}
            </div>
            {{ end }}
          </div>

          <!-- Split-Pane Core -->
          <div class="spec-core">
            <!-- Column A: Context -->
            <div class="spec-context">
              <div class="spec-abstract">
                <p>{{ $project.Description }}</p>
              </div>
              
              {{ if or $project.Params.designTradeoffs $project.Params.failureModes }}
              <div class="architecture-ledger">
                <h4 class="ledger-title">Architecture Ledger</h4>
                <ul class="ledger-list">
                  {{ if $project.Params.designTradeoffs }}
                  <li class="ledger-item">
                    <strong>Design Decision:</strong> {{ $project.Params.designTradeoffs }}
                  </li>
                  {{ end }}
                  {{ if $project.Params.failureModes }}
                    {{ range first 2 $project.Params.failureModes }}
                    <li class="ledger-item">
                      <strong>Resilience Pattern:</strong> {{ .scenario | default "N/A" }} → {{ .response | default "N/A" }}
                    </li>
                    {{ end }}
                  {{ end }}
                </ul>
              </div>
              {{ end }}
            </div>

            <!-- Column B: Media Stage -->
            <div class="spec-media">
              <div class="media-viewport blueprint-viewport">
                <div class="blueprint-grid-overlay"></div>
                <div class="viewport-tabs" role="tablist" aria-label="Technical viewport tabs">
                  <button 
                    class="viewport-tab active" 
                    role="tab" 
                    aria-selected="true" 
                    aria-expanded="true"
                    aria-controls="diagram-{{ $project.File.UniqueID }}"
                    id="tab-diagram-{{ $project.File.UniqueID }}"
                    data-tab="diagram"
                    data-project-id="{{ $project.File.UniqueID }}"
                  >
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                    </svg>
                    Diagram
                  </button>
                  <button 
                    class="viewport-tab" 
                    role="tab" 
                    aria-selected="false" 
                    aria-expanded="false"
                    aria-controls="loom-{{ $project.File.UniqueID }}"
                    id="tab-loom-{{ $project.File.UniqueID }}"
                    data-tab="loom"
                    data-project-id="{{ $project.File.UniqueID }}"
                  >
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Walkthrough
                  </button>
                  <button 
                    class="viewport-tab" 
                    role="tab" 
                    aria-selected="false" 
                    aria-expanded="false"
                    aria-controls="code-{{ $project.File.UniqueID }}"
                    id="tab-code-{{ $project.File.UniqueID }}"
                    data-tab="code"
                    data-project-id="{{ $project.File.UniqueID }}"
                  >
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                    </svg>
                    Code
                  </button>
                </div>

                <div class="viewport-content">
                  <!-- Diagram Tab -->
                  <div 
                    id="diagram-{{ $project.File.UniqueID }}" 
                    class="viewport-pane active" 
                    role="tabpanel" 
                    aria-labelledby="tab-diagram-{{ $project.File.UniqueID }}"
                  >
                    {{ if $project.Params.architectureDiagramUrl }}
                    <div class="diagram-container">
                      {{ if $project.Params.diagramPoster }}
                      <!-- Media Facade: Show poster until diagram tab is clicked -->
                      <div class="diagram-facade" data-diagram-url="{{ $project.Params.architectureDiagramUrl }}" data-project-id="{{ $project.File.UniqueID }}">
                        <img 
                          src="{{ $project.Params.diagramPoster }}" 
                          alt="Architecture diagram preview for {{ $project.Title }}"
                          class="diagram-poster"
                          loading="lazy"
                        />
                        <button class="diagram-load-button" aria-label="Load full architecture diagram">
                          <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                          </svg>
                          <span>Load Diagram</span>
                        </button>
                      </div>
                      {{ end }}
                      <img 
                        data-src="{{ $project.Params.architectureDiagramUrl }}" 
                        alt="Architecture diagram for {{ $project.Title }}"
                        class="diagram-image lazy-diagram"
                        style="display: {{ if $project.Params.diagramPoster }}none{{ else }}block{{ end }};"
                        loading="lazy"
                      />
                    </div>
                    {{ else if $project.Params.mermaidDiagram }}
                    <div class="mermaid-container">
                      <div class="mermaid" data-mermaid="{{ $project.Params.mermaidDiagram | htmlEscape }}">{{ $project.Params.mermaidDiagram }}</div>
                    </div>
                    {{ else }}
                    <div class="diagram-placeholder">
                      <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                      </svg>
                      <p>Architecture Diagram</p>
                    </div>
                    {{ end }}
                  </div>

                  <!-- Loom Tab -->
                  <div 
                    id="loom-{{ $project.File.UniqueID }}" 
                    class="viewport-pane" 
                    role="tabpanel" 
                    aria-labelledby="tab-loom-{{ $project.File.UniqueID }}"
                  >
                    {{ if $project.Params.loomUrl }}
                    <div class="loom-container">
                      {{ if $project.Params.loomPoster }}
                      <!-- Media Facade: Show poster until Loom tab is clicked -->
                      <div class="loom-poster" data-loom-url="{{ $project.Params.loomUrl }}" data-project-id="{{ $project.File.UniqueID }}">
                        <img src="{{ $project.Params.loomPoster }}" alt="Video thumbnail for {{ $project.Title }}" class="loom-poster-image" loading="lazy" />
                        <button class="loom-play-button" aria-label="Play system walkthrough video">
                          <svg width="48" height="48" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M8 5v14l11-7z"></path>
                          </svg>
                        </button>
                      </div>
                      {{ end }}
                      <iframe 
                        data-src="{{ $project.Params.loomUrl }}" 
                        class="loom-iframe lazy-iframe"
                        title="System walkthrough video for {{ $project.Title }}"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen
                        style="display: none;"
                      ></iframe>
                      <button class="transcript-button" aria-label="View transcript">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Transcript
                      </button>
                    </div>
                    {{ else }}
                    <div class="loom-placeholder">
                      <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                      <p>System Walkthrough</p>
                    </div>
                    {{ end }}
                  </div>

                  <!-- Code Tab -->
                  <div 
                    id="code-{{ $project.File.UniqueID }}" 
                    class="viewport-pane" 
                    role="tabpanel" 
                    aria-labelledby="tab-code-{{ $project.File.UniqueID }}"
                  >
                    {{ if $project.Params.codeSnippet }}
                    <div class="code-container">
                      <div class="code-header">
                        <span class="code-language">{{ $project.Params.codeLanguage | default "hcl" | upper }}</span>
                        <button class="copy-code-button" aria-label="Copy code to clipboard">
                          <svg class="copy-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                          </svg>
                          <svg class="check-icon" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true" style="display: none;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                          </svg>
                        </button>
                      </div>
                      <pre class="code-block"><code class="language-{{ $project.Params.codeLanguage | default "hcl" }}">{{ $project.Params.codeSnippet }}</code></pre>
                    </div>
                    {{ else }}
                    <div class="code-placeholder">
                      <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                      </svg>
                      <p>Code Snippet</p>
                    </div>
                    {{ end }}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Footer Actions -->
          <div class="spec-footer">
            <a href="{{ $project.RelPermalink }}" class="spec-link">View Full Specification →</a>
            <button class="manifest-button" data-project-id="{{ $project.File.UniqueID }}" aria-label="View deployment manifest">
              <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Deployment Manifest
            </button>
          </div>
        </article>
        {{ end }}
      </section>
      {{ end }}
      {{ end }}
    </div>
  </div>
</div>

<!-- Command Palette Modal -->
<div id="command-palette" class="command-palette" role="dialog" aria-labelledby="palette-title" aria-hidden="true">
  <div class="palette-overlay" aria-label="Close command palette"></div>
  <div class="palette-content">
    <div class="palette-header">
      <h3 id="palette-title" class="palette-title">Command Palette</h3>
      <button class="palette-close" aria-label="Close command palette">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <div class="palette-search-wrapper">
      <svg class="palette-search-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
      <input 
        type="search" 
        id="palette-search" 
        class="palette-search" 
        placeholder="Jump to project or filter by tech stack..."
        aria-label="Search projects"
        autocomplete="off"
      />
      <kbd class="palette-shortcut">
        <kbd class="kbd-key">{{ if eq .Site.Params.os "mac" }}⌘{{ else }}Ctrl{{ end }}</kbd>
        <kbd class="kbd-key">K</kbd>
      </kbd>
    </div>
    <div class="palette-results" id="palette-results" role="listbox" aria-label="Search results">
      <!-- Results populated by JavaScript -->
    </div>
  </div>
</div>

<!-- Deployment Manifest Modal -->
<div id="manifest-modal" class="modal" role="dialog" aria-labelledby="modal-title" aria-hidden="true">
  <div class="modal-overlay" aria-label="Close modal"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modal-title" class="modal-title">Deployment Manifest</h3>
      <button class="modal-close" aria-label="Close modal">
        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <pre class="manifest-yaml"><code id="manifest-content" class="language-yaml"></code></pre>
    </div>
  </div>
</div>
{{ end }}
