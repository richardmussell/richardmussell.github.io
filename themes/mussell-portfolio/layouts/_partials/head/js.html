{{- with resources.Get "js/main.js" }}
  {{- $opts := dict
    "minify" (not hugo.IsDevelopment)
    "sourceMap" (cond hugo.IsDevelopment "external" "")
    "targetPath" "js/main.js"
  }}
  {{- with . | js.Build $opts }}
    {{- if hugo.IsDevelopment }}
      <script src="{{ .RelPermalink }}"></script>
    {{- else }}
      {{- with . | fingerprint }}
        <script src="{{ .RelPermalink }}" integrity="{{ .Data.Integrity }}" crossorigin="anonymous"></script>
      {{- end }}
    {{- end }}
  {{- end }}
{{- end }}

<script>
  // Reading Progress Indicator
  (function() {
    const progressBar = document.createElement('div');
    progressBar.className = 'reading-progress';
    document.body.appendChild(progressBar);

    function updateProgress() {
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const scrollableHeight = documentHeight - windowHeight;
      const progress = scrollableHeight > 0 ? (scrollTop / scrollableHeight) * 100 : 0;
      progressBar.style.width = Math.min(Math.max(progress, 0), 100) + '%';
    }

    // Throttle scroll events
    let ticking = false;
    window.addEventListener('scroll', function() {
      if (!ticking) {
        window.requestAnimationFrame(function() {
          updateProgress();
          ticking = false;
        });
        ticking = true;
      }
    }, { passive: true });

    updateProgress();
  })();

  // Header scroll behavior removed - header scrolls normally with page

  // Scroll to Top Button - Enterprise Ready with Accessibility
  (function() {
    const scrollToTopButton = document.getElementById('scroll-to-top');
    if (!scrollToTopButton) return;

    const scrollThreshold = 400; // Show button after scrolling 400px
    let ticking = false;

    function updateButtonVisibility() {
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      
      if (scrollTop > scrollThreshold) {
        scrollToTopButton.classList.add('visible');
        scrollToTopButton.setAttribute('aria-hidden', 'false');
      } else {
        scrollToTopButton.classList.remove('visible');
        scrollToTopButton.setAttribute('aria-hidden', 'true');
      }
    }

    function scrollToTop() {
      // Smooth scroll to top
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
      
      // Focus management for accessibility
      scrollToTopButton.blur();
      
      // Announce to screen readers
      const announcement = document.createElement('div');
      announcement.setAttribute('role', 'status');
      announcement.setAttribute('aria-live', 'polite');
      announcement.setAttribute('aria-atomic', 'true');
      announcement.className = 'sr-only';
      announcement.textContent = 'Scrolled to top of page';
      document.body.appendChild(announcement);
      
      setTimeout(() => {
        document.body.removeChild(announcement);
      }, 1000);
    }

    // Handle scroll events
    window.addEventListener('scroll', function() {
      if (!ticking) {
        window.requestAnimationFrame(function() {
          updateButtonVisibility();
          ticking = false;
        });
        ticking = true;
      }
    }, { passive: true });

    // Handle button click
    scrollToTopButton.addEventListener('click', scrollToTop);

    // Handle keyboard navigation (Enter and Space)
    scrollToTopButton.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        scrollToTop();
      }
    });

    // Initial state
    updateButtonVisibility();
  })();

  // Screen reader only class for accessibility announcements
  if (!document.querySelector('style[data-sr-only]')) {
    const style = document.createElement('style');
    style.setAttribute('data-sr-only', 'true');
    style.textContent = `
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
      }
    `;
    document.head.appendChild(style);
  }
  
  // Mac Window Tab Switching
  (function() {
    const macTabs = document.querySelectorAll('.mac-tab');
    macTabs.forEach(tab => {
      tab.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const window = this.closest('.mac-window');
        const tabName = this.getAttribute('data-tab');
        
        // Update active tab
        window.querySelectorAll('.mac-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // Update active content
        window.querySelectorAll('.mac-tab-content').forEach(content => {
          content.classList.remove('active');
          if (content.getAttribute('data-content') === tabName) {
            content.classList.add('active');
          }
        });
      });
    });
  })();
  
  // Smooth Scroll for Domain Tabs
  (function() {
    const domainTabs = document.querySelectorAll('.domain-tab');
    domainTabs.forEach(tab => {
      tab.addEventListener('click', function(e) {
        const href = this.getAttribute('href');
        if (href && href.includes('#')) {
          e.preventDefault();
          const targetId = href.split('#')[1];
          const targetElement = document.getElementById(targetId);
          if (targetElement) {
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }
      });
    });
  })();
  
  // Staggered Mount Animation for Domain Sections
  (function() {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry, index) => {
        if (entry.isIntersecting) {
          setTimeout(() => {
            entry.target.style.opacity = '1';
            entry.target.style.transform = 'translateY(0)';
          }, index * 100);
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.1 });
    
    document.querySelectorAll('.domain-section').forEach(section => {
      section.style.opacity = '0';
      section.style.transform = 'translateY(20px)';
      section.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
      observer.observe(section);
    });
  })();
  
  // Technical Registry Functionality
  (function() {
    // Search Functionality
    const searchInput = document.getElementById('service-search');
    if (searchInput) {
      let searchTimeout;
      searchInput.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        const query = e.target.value.toLowerCase().trim();
        
        searchTimeout = setTimeout(() => {
          filterProjects(query, getActiveTags());
        }, 300);
      });
    }
    
    // Tag Filter Functionality
    const tagFilters = document.querySelectorAll('.tag-filter');
    tagFilters.forEach(filter => {
      filter.addEventListener('click', function() {
        const isChecked = this.getAttribute('aria-checked') === 'true';
        this.setAttribute('aria-checked', !isChecked);
        this.classList.toggle('active', !isChecked);
        
        const query = searchInput ? searchInput.value.toLowerCase().trim() : '';
        filterProjects(query, getActiveTags());
      });
    });
    
    function getActiveTags() {
      const activeTags = [];
      document.querySelectorAll('.tag-filter[aria-checked="true"]').forEach(filter => {
        activeTags.push(filter.getAttribute('data-tag'));
      });
      return activeTags;
    }
    
    function filterProjects(searchQuery, activeTags) {
      const projects = document.querySelectorAll('.system-spec');
      let visibleCount = 0;
      
      projects.forEach(project => {
        const projectId = project.getAttribute('data-project-id');
        const projectTags = project.getAttribute('data-tags').split(' ').filter(t => t);
        const projectText = project.textContent.toLowerCase();
        
        // Search filter
        const matchesSearch = !searchQuery || projectText.includes(searchQuery);
        
        // Tag filter
        const matchesTags = activeTags.length === 0 || 
          activeTags.some(tag => projectTags.includes(tag));
        
        if (matchesSearch && matchesTags) {
          project.classList.remove('hidden');
          visibleCount++;
        } else {
          project.classList.add('hidden');
        }
      });
      
      // Hide empty sections
      document.querySelectorAll('.registry-section').forEach(section => {
        const visibleProjects = section.querySelectorAll('.system-spec:not(.hidden)');
        if (visibleProjects.length === 0) {
          section.style.display = 'none';
        } else {
          section.style.display = 'block';
        }
      });
      
      // Update results count
      const countElement = document.querySelector('.sidebar-count');
      if (countElement) {
        countElement.textContent = `${visibleCount} Services`;
      }
    }
    
    // Tab Switching
    document.querySelectorAll('.viewport-tab').forEach(tab => {
      tab.addEventListener('click', function(e) {
        e.preventDefault();
        const projectId = this.id.split('-').slice(-2).join('-');
        const tabName = this.getAttribute('data-tab');
        const viewport = this.closest('.media-viewport');
        
        // Update active tab
        viewport.querySelectorAll('.viewport-tab').forEach(t => {
          t.classList.remove('active');
          t.setAttribute('aria-selected', 'false');
        });
        this.classList.add('active');
        this.setAttribute('aria-selected', 'true');
        
        // Update active pane
        viewport.querySelectorAll('.viewport-pane').forEach(pane => {
          pane.classList.remove('active');
        });
        const targetPane = viewport.querySelector(`#${tabName}-${projectId}`);
        if (targetPane) {
          targetPane.classList.add('active');
        }
      });
    });
    
    // Smooth Scroll for TOC Links
    document.querySelectorAll('.toc-link').forEach(link => {
      link.addEventListener('click', function(e) {
        const href = this.getAttribute('href');
        if (href && href.startsWith('#')) {
          e.preventDefault();
          const targetId = href.substring(1);
          const targetElement = document.getElementById(targetId);
          if (targetElement) {
            const headerOffset = 120;
            const elementPosition = targetElement.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
            
            window.scrollTo({
              top: offsetPosition,
              behavior: 'smooth'
            });
            
            // Update focus for accessibility
            targetElement.setAttribute('tabindex', '-1');
            targetElement.focus();
          }
        }
      });
    });
    
    // Modal Functionality
    const modal = document.getElementById('manifest-modal');
    const manifestButtons = document.querySelectorAll('.manifest-button');
    const modalClose = document.querySelector('.modal-close');
    const modalOverlay = document.querySelector('.modal-overlay');
    
    // Mock manifest data (in production, this would come from the project data)
    const manifestTemplates = {
      default: `apiVersion: v1
kind: Deployment
metadata:
  name: {{ "{{" }}PROJECT_NAME{{ "}}" }}
  labels:
    app: {{ "{{" }}PROJECT_NAME{{ "}}" }}
    version: v1.0.0
spec:
  replicas: 3
  selector:
    matchLabels:
      app: {{ "{{" }}PROJECT_NAME{{ "}}" }}
  template:
    metadata:
      labels:
        app: {{ "{{" }}PROJECT_NAME{{ "}}" }}
    spec:
      containers:
      - name: {{ "{{" }}PROJECT_NAME{{ "}}" }}
        image: {{ "{{" }}IMAGE{{ "}}" }}
        ports:
        - containerPort: 8080
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"`
    };
    
    manifestButtons.forEach(button => {
      button.addEventListener('click', function() {
        const projectId = this.getAttribute('data-project-id');
        const project = document.querySelector(`[data-project-id="${projectId}"]`);
        const projectTitle = project ? project.querySelector('.spec-title').textContent : 'Project';
        
        const manifestContent = document.getElementById('manifest-content');
        if (manifestContent) {
          manifestContent.textContent = manifestTemplates.default
            .replace(/\{\{PROJECT_NAME\}\}/g, projectTitle.toLowerCase().replace(/\s+/g, '-'))
            .replace(/\{\{IMAGE\}\}/g, `registry.example.com/${projectTitle.toLowerCase().replace(/\s+/g, '-')}:latest`);
        }
        
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        
        // Focus management
        const closeButton = modal.querySelector('.modal-close');
        if (closeButton) {
          closeButton.focus();
        }
      });
    });
    
    function closeModal() {
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      
      // Return focus to the button that opened the modal
      const activeButton = document.activeElement;
      if (activeButton && activeButton.classList.contains('manifest-button')) {
        activeButton.focus();
      }
    }
    
    if (modalClose) {
      modalClose.addEventListener('click', closeModal);
    }
    
    if (modalOverlay) {
      modalOverlay.addEventListener('click', closeModal);
    }
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false') {
        closeModal();
      }
    });
    
    // Trap focus within modal
    if (modal) {
      const focusableElements = modal.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      const firstElement = focusableElements[0];
      const lastElement = focusableElements[focusableElements.length - 1];
      
      modal.addEventListener('keydown', function(e) {
        if (e.key !== 'Tab' || modal.getAttribute('aria-hidden') === 'true') return;
        
        if (e.shiftKey) {
          if (document.activeElement === firstElement) {
            e.preventDefault();
            lastElement.focus();
          }
        } else {
          if (document.activeElement === lastElement) {
            e.preventDefault();
            firstElement.focus();
          }
        }
      });
    }
  })();
</script>
